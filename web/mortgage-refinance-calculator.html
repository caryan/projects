<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mortgage Refinance Calculator</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background-color: #fff;
            color: #333;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 1.75em;
            font-weight: 600;
        }

        .input-section {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 12px;
        }

        .input-section h2 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1em;
            color: #333;
            border-bottom: 1px solid #ddd;
            padding-bottom: 6px;
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            margin-bottom: 3px;
            font-weight: 500;
            color: #444;
            font-size: 0.85em;
        }

        input, select {
            width: 100%;
            padding: 6px 8px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 4px;
            transition: border-color 0.2s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #007bff;
        }

        input.invalid {
            border-color: #c62828;
            background-color: #fff8f8;
        }

        input.invalid:focus {
            border-color: #c62828;
        }

        input::placeholder {
            color: #999;
        }

        .currency-input {
            position: relative;
        }

        .currency-input::before {
            content: "$";
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            font-size: 14px;
            pointer-events: none;
        }

        .currency-input input {
            padding-left: 20px;
        }

        .input-hint {
            font-size: 0.75em;
            color: #666;
            margin-top: 2px;
        }

        .arm-fields {
            display: none;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ccc;
        }

        .arm-fields.visible {
            display: block;
        }

        .arm-note {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 4px;
            padding: 6px 8px;
            font-size: 0.8em;
            color: #856404;
            margin-bottom: 10px;
        }

        .results-section {
            background-color: #f0f7ff;
            border: 1px solid #b8d4f0;
            border-radius: 5px;
            padding: 12px;
            margin-bottom: 12px;
        }


        footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            text-align: center;
            color: #888;
            font-size: 0.85em;
        }

        footer a {
            color: #007bff;
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        /* Multi-scenario styles */
        .input-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .current-loan-section {
            flex-shrink: 0;
            width: 280px;
        }

        .scenarios-container {
            display: flex;
            gap: 12px;
            flex: 1;
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .scenario-section {
            min-width: 280px;
            flex-shrink: 0;
        }

        .scenario-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0;
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 1px solid #ddd;
        }

        .scenario-header h2 {
            margin: 0;
            padding: 0;
            border: none;
            font-size: 1em;
            color: #333;
        }

        .remove-scenario-btn {
            background: none;
            border: none;
            font-size: 1.4em;
            color: #999;
            cursor: pointer;
            padding: 0 4px;
            line-height: 1;
        }

        .remove-scenario-btn:hover {
            color: #c62828;
        }

        .remove-scenario-btn:disabled {
            color: #ddd;
            cursor: not-allowed;
        }

        .add-scenario-box {
            min-width: 280px;
            flex-shrink: 0;
            background: #f5f5f5;
            border: 2px dashed #ccc;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 200px;
        }

        .add-scenario-box:hover {
            background: #e8f5e9;
            border-color: #4caf50;
        }

        .add-scenario-box:hover .add-scenario-content {
            color: #2e7d32;
        }

        .add-scenario-content {
            text-align: center;
            color: #999;
            transition: color 0.2s;
        }

        .add-scenario-content .plus-icon {
            font-size: 2.5em;
            line-height: 1;
            margin-bottom: 8px;
        }

        .add-scenario-content .add-text {
            font-size: 0.9em;
        }

        /* Comparison table wrapper */
        .comparison-wrapper {
            overflow-x: auto;
            margin: 0 -12px;
            padding: 0 12px;
        }

        .comparison-table {
            width: 100%;
            min-width: max-content;
            border-collapse: collapse;
            background-color: #fff;
            border-radius: 4px;
            overflow: hidden;
            font-size: 0.85em;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 8px 12px;
            text-align: right;
            border-bottom: 1px solid #eee;
            white-space: nowrap;
        }

        .comparison-table th:first-child,
        .comparison-table td:first-child {
            text-align: left;
            position: sticky;
            left: 0;
            background: #fff;
            z-index: 1;
            min-width: 130px;
        }

        .comparison-table th {
            background-color: #f5f5f5;
            font-weight: 600;
            color: #444;
        }

        .comparison-table th:first-child {
            background-color: #f5f5f5;
        }

        .comparison-table .current-col {
            background-color: #fafafa;
        }

        .comparison-table td:first-child {
            font-weight: 500;
        }

        .comparison-table tr:last-child td {
            border-bottom: none;
        }

        .comparison-table .best-value {
            background-color: #e8f5e9;
            font-weight: 600;
            color: #2e7d32;
        }

        .comparison-table .worst-value {
            background-color: #ffebee;
            color: #c62828;
        }

        .comparison-table .highlight-row td {
            background-color: #e3f2fd;
            font-weight: 600;
        }

        .comparison-table .highlight-row td:first-child {
            background-color: #e3f2fd;
        }

        .comparison-table .highlight-row .best-value {
            background-color: #c8e6c9;
        }

        .comparison-table .highlight-row .worst-value {
            background-color: #ffcdd2;
        }

        .value-detail {
            font-size: 0.85em;
            color: #666;
            font-weight: normal;
        }

        @media (max-width: 768px) {
            .input-row {
                flex-direction: column;
            }

            .current-loan-section {
                width: 100%;
            }

            .scenarios-container {
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <h1>Mortgage Refinance Calculator</h1>

    <div class="input-row">
        <div class="input-section current-loan-section">
            <h2>Current Loan</h2>

            <div class="form-group">
                <label for="currentBalance">Remaining Balance</label>
                <div class="currency-input">
                    <input type="text" id="currentBalance" placeholder="e.g., 500,000" inputmode="decimal">
                </div>
            </div>

            <div class="form-group">
                <label for="currentRate">Interest Rate (%)</label>
                <input type="text" id="currentRate" placeholder="e.g., 6.625" inputmode="decimal">
            </div>

            <div class="form-group">
                <label for="currentPayment">Monthly Payment (P&I)</label>
                <div class="currency-input">
                    <input type="text" id="currentPayment" placeholder="e.g., 3,200" inputmode="decimal" aria-describedby="currentPaymentHint">
                </div>
                <div class="input-hint" id="currentPaymentHint">Principal & interest only (exclude taxes/insurance)</div>
            </div>
        </div>

        <div class="scenarios-container" id="scenariosContainer">
            <!-- Scenarios and add button will be rendered here by JavaScript -->
        </div>
    </div>

    <div class="results-section">
        <div class="comparison-wrapper">
            <table class="comparison-table" id="comparisonTable">
                <thead>
                    <tr id="comparisonHeader">
                        <th></th>
                        <th class="current-col">Current</th>
                        <!-- Scenario headers will be added by JavaScript -->
                    </tr>
                </thead>
                <tbody id="comparisonBody">
                    <!-- Comparison rows will be rendered by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <footer>
        Part of <a href="https://projects.colmryan.org">projects.colmryan.org</a>
    </footer>

    <script>
        // State management
        const state = {
            scenarios: [],
            nextScenarioId: 1
        };

        // DOM Elements
        const currentBalanceInput = document.getElementById('currentBalance');
        const currentRateInput = document.getElementById('currentRate');
        const currentPaymentInput = document.getElementById('currentPayment');
        const scenariosContainer = document.getElementById('scenariosContainer');
        const comparisonHeader = document.getElementById('comparisonHeader');
        const comparisonBody = document.getElementById('comparisonBody');

        // Utility functions
        function parseNumber(str) {
            if (!str) return NaN;
            return parseFloat(str.replace(/[$,]/g, ''));
        }

        function formatCurrency(amount) {
            if (isNaN(amount) || !isFinite(amount)) return '--';
            return '$' + amount.toLocaleString('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        }

        function formatInputCurrency(input) {
            const value = parseNumber(input.value);
            if (!isNaN(value) && value > 0) {
                input.value = value.toLocaleString('en-US');
            }
        }

        function validateInput(input, options = {}) {
            const value = parseNumber(input.value);
            const isEmpty = input.value.trim() === '';
            const { allowEmpty = true, min = 0, max = Infinity, isRate = false } = options;

            let isValid = true;

            if (isEmpty) {
                isValid = allowEmpty;
            } else if (isNaN(value)) {
                isValid = false;
            } else if (value < min || value > max) {
                isValid = false;
            } else if (isRate && value > 30) {
                // Rate sanity check - rates above 30% are likely errors
                isValid = false;
            }

            input.classList.toggle('invalid', !isValid);
            return isValid;
        }

        function validateAllInputs() {
            // Validate current loan inputs
            validateInput(currentBalanceInput, { allowEmpty: true, min: 1 });
            validateInput(currentRateInput, { allowEmpty: true, min: 0, isRate: true });
            validateInput(currentPaymentInput, { allowEmpty: true, min: 1 });

            // Validate scenario inputs
            document.querySelectorAll('.scenario-rate').forEach(input => {
                validateInput(input, { allowEmpty: true, min: 0, isRate: true });
            });
            document.querySelectorAll('.scenario-arm-rate').forEach(input => {
                validateInput(input, { allowEmpty: true, min: 0, isRate: true });
            });
            document.querySelectorAll('.scenario-points').forEach(input => {
                validateInput(input, { allowEmpty: true, min: 0, max: 10 });
            });
            document.querySelectorAll('.scenario-closing-costs').forEach(input => {
                validateInput(input, { allowEmpty: true, min: 0 });
            });
        }

        function formatMonths(months) {
            if (isNaN(months) || !isFinite(months) || months < 0) return '--';
            const years = Math.floor(months / 12);
            const remainingMonths = Math.round(months % 12);

            if (years === 0) {
                return `${remainingMonths} month${remainingMonths !== 1 ? 's' : ''}`;
            } else if (remainingMonths === 0) {
                return `${years} year${years !== 1 ? 's' : ''}`;
            } else {
                return `${years} yr ${remainingMonths} mo`;
            }
        }

        function getTermLabel(termValue) {
            const labels = {
                '30': '30 Year Fixed',
                '20': '20 Year Fixed',
                '15': '15 Year Fixed',
                '5/1': '5/1 ARM',
                '7/1': '7/1 ARM'
            };
            return labels[termValue] || termValue;
        }

        // Calculation functions
        function calculateMonthlyPayment(principal, annualRate, termYears) {
            if (principal <= 0 || annualRate < 0 || termYears <= 0) return NaN;

            const monthlyRate = annualRate / 100 / 12;
            const numPayments = termYears * 12;

            if (monthlyRate === 0) {
                return principal / numPayments;
            }

            const payment = principal * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) /
                           (Math.pow(1 + monthlyRate, numPayments) - 1);
            return payment;
        }

        function getTermYears(termValue) {
            if (termValue === '5/1' || termValue === '7/1') {
                return 30;
            }
            return parseInt(termValue);
        }

        function isARM(termValue) {
            return termValue === '5/1' || termValue === '7/1';
        }

        function calculateRemainingTerm(balance, annualRate, monthlyPayment) {
            if (balance <= 0 || annualRate < 0 || monthlyPayment <= 0) return NaN;

            const monthlyRate = annualRate / 100 / 12;

            if (monthlyRate === 0) {
                return balance / monthlyPayment;
            }

            const monthlyInterest = balance * monthlyRate;
            if (monthlyPayment <= monthlyInterest) {
                return Infinity;
            }

            const n = -Math.log(1 - (monthlyRate * balance) / monthlyPayment) / Math.log(1 + monthlyRate);
            return n;
        }

        function calculateTotalInterest(principal, monthlyPayment, termMonths) {
            if (isNaN(principal) || isNaN(monthlyPayment) || isNaN(termMonths)) return NaN;
            return (monthlyPayment * termMonths) - principal;
        }

        function calculateRemainingBalance(principal, annualRate, monthlyPayment, monthsPaid) {
            const monthlyRate = annualRate / 100 / 12;
            if (monthlyRate === 0) {
                return Math.max(0, principal - (monthlyPayment * monthsPaid));
            }
            const balance = principal * Math.pow(1 + monthlyRate, monthsPaid) -
                           monthlyPayment * (Math.pow(1 + monthlyRate, monthsPaid) - 1) / monthlyRate;
            return Math.max(0, balance);
        }

        function calculateARMTotalInterest(principal, initialRate, adjustedRate, termValue, termYears) {
            const fixedPeriodYears = termValue === '5/1' ? 5 : 7;
            const fixedPeriodMonths = fixedPeriodYears * 12;
            const totalMonths = termYears * 12;
            const remainingMonths = totalMonths - fixedPeriodMonths;

            // Calculate initial payment based on full term at initial rate
            const initialPayment = calculateMonthlyPayment(principal, initialRate, termYears);

            // Calculate balance at end of fixed period
            const balanceAfterFixed = calculateRemainingBalance(principal, initialRate, initialPayment, fixedPeriodMonths);

            // Interest paid during fixed period
            const principalPaidFixed = principal - balanceAfterFixed;
            const fixedPeriodInterest = (initialPayment * fixedPeriodMonths) - principalPaidFixed;

            // Calculate new payment for remaining term at adjusted rate
            const remainingYears = remainingMonths / 12;
            const adjustedPayment = calculateMonthlyPayment(balanceAfterFixed, adjustedRate, remainingYears);

            // Interest paid during adjusted period
            const adjustedPeriodInterest = (adjustedPayment * remainingMonths) - balanceAfterFixed;

            return {
                initialPayment,
                adjustedPayment,
                totalInterest: fixedPeriodInterest + adjustedPeriodInterest,
                balanceAfterFixed
            };
        }

        // Scenario management
        function createScenario() {
            const id = state.nextScenarioId++;
            // Name based on position it will be added (current length + 1)
            const position = state.scenarios.length + 1;
            return {
                id,
                name: `Scenario ${position}`,
                term: '30',
                rate: '',
                armAdjustedRate: '',
                points: '0',
                closingCosts: '0'
            };
        }

        function addScenario() {
            const scenario = createScenario();
            state.scenarios.push(scenario);
            renderScenarioInputs();
            renderResults();
            updateURL();
        }

        function isDefaultName(name) {
            return /^Scenario \d+$/.test(name);
        }

        function removeScenario(id) {
            if (state.scenarios.length <= 1) return;
            state.scenarios = state.scenarios.filter(s => s.id !== id);

            // Renumber scenarios with default names
            state.scenarios.forEach((scenario, index) => {
                if (isDefaultName(scenario.name)) {
                    scenario.name = `Scenario ${index + 1}`;
                }
            });

            renderScenarioInputs();
            renderResults();
            updateURL();
        }

        function getScenarioFromDOM(id) {
            const section = scenariosContainer.querySelector(`[data-scenario-id="${id}"]`);
            if (!section) return null;

            return {
                id,
                name: section.querySelector('.scenario-name').textContent,
                term: section.querySelector('.scenario-term').value,
                rate: section.querySelector('.scenario-rate').value,
                armAdjustedRate: section.querySelector('.scenario-arm-rate')?.value || '',
                points: section.querySelector('.scenario-points').value,
                closingCosts: section.querySelector('.scenario-closing-costs').value
            };
        }

        function syncScenariosFromDOM() {
            state.scenarios = state.scenarios.map(s => getScenarioFromDOM(s.id) || s);
        }

        function createScenarioHTML(scenario) {
            const isARMLoan = isARM(scenario.term);
            return `
                <div class="input-section scenario-section" data-scenario-id="${scenario.id}">
                    <div class="scenario-header">
                        <h2 class="scenario-name" contenteditable="true" role="textbox" aria-label="Scenario name">${scenario.name}</h2>
                        <button class="remove-scenario-btn" title="Remove scenario" aria-label="Remove ${scenario.name}" ${state.scenarios.length <= 1 ? 'disabled' : ''}>&times;</button>
                    </div>

                    <div class="form-group">
                        <label for="scenario-${scenario.id}-term">Loan Term</label>
                        <select id="scenario-${scenario.id}-term" class="scenario-term">
                            <option value="30" ${scenario.term === '30' ? 'selected' : ''}>30 Year Fixed</option>
                            <option value="20" ${scenario.term === '20' ? 'selected' : ''}>20 Year Fixed</option>
                            <option value="15" ${scenario.term === '15' ? 'selected' : ''}>15 Year Fixed</option>
                            <option value="5/1" ${scenario.term === '5/1' ? 'selected' : ''}>5/1 ARM</option>
                            <option value="7/1" ${scenario.term === '7/1' ? 'selected' : ''}>7/1 ARM</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="scenario-${scenario.id}-rate">Interest Rate (%)</label>
                        <input type="text" id="scenario-${scenario.id}-rate" class="scenario-rate" placeholder="e.g., 5.5" inputmode="decimal" value="${scenario.rate}">
                    </div>

                    <div class="arm-fields ${isARMLoan ? 'visible' : ''}">
                        <div class="arm-note">
                            ARM rates adjust after the initial fixed period. Enter the rate you expect after adjustment.
                        </div>
                        <div class="form-group">
                            <label for="scenario-${scenario.id}-arm-rate">Expected Rate After Adjustment (%)</label>
                            <input type="text" id="scenario-${scenario.id}-arm-rate" class="scenario-arm-rate" placeholder="e.g., 7.0" inputmode="decimal" value="${scenario.armAdjustedRate}">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="scenario-${scenario.id}-points">Points</label>
                        <input type="text" id="scenario-${scenario.id}-points" class="scenario-points" placeholder="e.g., 1" inputmode="decimal" value="${scenario.points}">
                        <div class="input-hint">Each point = 1% of loan amount</div>
                    </div>

                    <div class="form-group">
                        <label for="scenario-${scenario.id}-closing-costs">Other Closing Costs</label>
                        <div class="currency-input">
                            <input type="text" id="scenario-${scenario.id}-closing-costs" class="scenario-closing-costs" placeholder="e.g., 5,000" inputmode="decimal" value="${scenario.closingCosts}">
                        </div>
                    </div>
                </div>
            `;
        }

        function renderScenarioInputs() {
            // Render scenarios plus the add button placeholder
            const scenariosHTML = state.scenarios.map(s => createScenarioHTML(s)).join('');
            const addButtonHTML = `
                <div class="add-scenario-box" id="addScenarioBox" role="button" tabindex="0" aria-label="Add new refinance scenario">
                    <div class="add-scenario-content">
                        <div class="plus-icon">+</div>
                        <div class="add-text">Add Scenario</div>
                    </div>
                </div>
            `;
            scenariosContainer.innerHTML = scenariosHTML + addButtonHTML;

            // Update remove button states
            const removeButtons = scenariosContainer.querySelectorAll('.remove-scenario-btn');
            removeButtons.forEach(btn => {
                btn.disabled = state.scenarios.length <= 1;
            });

            // Format money inputs
            scenariosContainer.querySelectorAll('.scenario-closing-costs').forEach(input => {
                formatInputCurrency(input);
            });
        }

        // Parse current loan from DOM
        function parseCurrentLoan() {
            const balance = parseNumber(currentBalanceInput.value);
            const rate = parseNumber(currentRateInput.value);
            const payment = parseNumber(currentPaymentInput.value);
            const remainingMonths = calculateRemainingTerm(balance, rate, payment);
            const totalInterest = calculateTotalInterest(balance, payment, remainingMonths);
            const totalPayments = payment * remainingMonths;

            return {
                balance,
                rate,
                payment,
                remainingMonths,
                totalInterest,
                totalPayments
            };
        }

        // Calculate results for a single scenario
        function calculateScenarioResults(currentLoan, scenario) {
            const balance = currentLoan.balance;
            const rate = parseNumber(scenario.rate);
            const termYears = getTermYears(scenario.term);
            const termMonths = termYears * 12;
            const points = parseNumber(scenario.points) || 0;
            const closingCosts = parseNumber(scenario.closingCosts) || 0;
            const isARMLoan = isARM(scenario.term);
            const armAdjustedRate = parseNumber(scenario.armAdjustedRate);

            let monthlyPayment, totalInterest, adjustedPayment;

            if (isARMLoan && !isNaN(armAdjustedRate) && armAdjustedRate > 0) {
                // ARM with adjusted rate specified
                const armResult = calculateARMTotalInterest(balance, rate, armAdjustedRate, scenario.term, termYears);
                monthlyPayment = armResult.initialPayment;
                adjustedPayment = armResult.adjustedPayment;
                totalInterest = armResult.totalInterest;
            } else {
                // Fixed rate or ARM without adjusted rate
                monthlyPayment = calculateMonthlyPayment(balance, rate, termYears);
                totalInterest = calculateTotalInterest(balance, monthlyPayment, termMonths);
            }

            const pointsCost = (points / 100) * balance;
            const totalRefinancingCost = pointsCost + closingCosts;
            const totalPayments = (adjustedPayment !== undefined)
                ? totalInterest + balance + totalRefinancingCost  // Derived from total interest for ARMs
                : monthlyPayment * termMonths;

            // Improved breakeven calculation using cumulative savings approach
            // Simulates month-by-month to find when savings exceed costs
            let breakevenMonths = calculateBreakevenMonths(
                currentLoan.balance,
                currentLoan.rate,
                currentLoan.payment,
                balance,
                rate,
                monthlyPayment,
                totalRefinancingCost
            );

            // Lifetime savings
            const lifetimeSavings = (currentLoan.totalInterest - totalInterest) - totalRefinancingCost;

            return {
                scenarioId: scenario.id,
                scenarioName: scenario.name,
                term: scenario.term,
                rate,
                monthlyPayment,
                adjustedPayment,
                paymentDiff: currentLoan.payment - monthlyPayment,
                totalInterest,
                totalPayments,
                termMonths,
                refinancingCost: totalRefinancingCost,
                breakevenMonths,
                lifetimeSavings
            };
        }

        // Calculate breakeven by simulating month-by-month savings
        function calculateBreakevenMonths(currentBalance, currentRate, currentPayment,
                                          newBalance, newRate, newPayment, refinancingCost) {
            if (isNaN(currentBalance) || isNaN(newBalance) || isNaN(refinancingCost)) return NaN;
            if (refinancingCost === 0 && newPayment <= currentPayment) return 0;

            const currentMonthlyRate = currentRate / 100 / 12;
            const newMonthlyRate = newRate / 100 / 12;

            let currentBal = currentBalance;
            let newBal = newBalance;
            let cumulativeSavings = -refinancingCost; // Start negative due to upfront costs

            const maxMonths = 360; // 30 years max

            for (let month = 1; month <= maxMonths; month++) {
                // Interest for current loan this month
                const currentInterest = currentBal * currentMonthlyRate;
                const currentPrincipal = Math.min(currentPayment - currentInterest, currentBal);
                currentBal = Math.max(0, currentBal - currentPrincipal);

                // Interest for new loan this month
                const newInterest = newBal * newMonthlyRate;
                const newPrincipal = Math.min(newPayment - newInterest, newBal);
                newBal = Math.max(0, newBal - newPrincipal);

                // Monthly savings = interest saved (principal paid is not a "cost")
                const interestSaved = currentInterest - newInterest;
                cumulativeSavings += interestSaved;

                if (cumulativeSavings >= 0) {
                    return month;
                }

                // If both loans paid off, stop
                if (currentBal === 0 && newBal === 0) break;
            }

            return Infinity; // Never breaks even within 30 years
        }

        // Render results comparison table
        function renderResults() {
            syncScenariosFromDOM();
            validateAllInputs();
            const currentLoan = parseCurrentLoan();
            const scenarioResults = state.scenarios.map(s => calculateScenarioResults(currentLoan, s));

            // Build header
            let headerHTML = '<th></th><th class="current-col">Current</th>';
            scenarioResults.forEach(r => {
                headerHTML += `<th>${r.scenarioName}</th>`;
            });
            comparisonHeader.innerHTML = headerHTML;

            // Metrics to compare
            const metrics = [
                {
                    label: 'Monthly Payment',
                    current: currentLoan.payment,
                    values: scenarioResults.map(r => r.monthlyPayment),
                    format: formatCurrency,
                    lowerIsBetter: true,
                    detail: scenarioResults.map(r => {
                        let detail = '';
                        if (!isNaN(r.paymentDiff)) {
                            if (r.paymentDiff > 0) detail = `${formatCurrency(r.paymentDiff)}/mo less`;
                            else if (r.paymentDiff < 0) detail = `${formatCurrency(Math.abs(r.paymentDiff))}/mo more`;
                            else detail = 'Same';
                        }
                        // Show adjusted payment for ARMs
                        if (r.adjustedPayment !== undefined) {
                            detail += detail ? `, then ${formatCurrency(r.adjustedPayment)}` : `Then ${formatCurrency(r.adjustedPayment)}`;
                        }
                        return detail;
                    })
                },
                {
                    label: 'Interest (1st Payment)',
                    current: currentLoan.balance * (currentLoan.rate / 100 / 12),
                    values: scenarioResults.map(r => currentLoan.balance * (r.rate / 100 / 12)),
                    format: formatCurrency,
                    lowerIsBetter: true,
                    detail: scenarioResults.map(r => {
                        const currentInterest = currentLoan.balance * (currentLoan.rate / 100 / 12);
                        const newInterest = currentLoan.balance * (r.rate / 100 / 12);
                        const diff = currentInterest - newInterest;
                        if (diff > 0) return `${formatCurrency(diff)}/mo less`;
                        else if (diff < 0) return `${formatCurrency(Math.abs(diff))}/mo more`;
                        return 'Same';
                    })
                },
                {
                    label: 'Interest Rate',
                    current: currentLoan.rate,
                    values: scenarioResults.map(r => r.rate),
                    format: v => isNaN(v) ? '--' : v.toFixed(3) + '%',
                    lowerIsBetter: true
                },
                {
                    label: 'Loan Term',
                    current: currentLoan.remainingMonths,
                    values: scenarioResults.map(r => r.termMonths),
                    format: formatMonths,
                    lowerIsBetter: true,
                    detail: scenarioResults.map(r => getTermLabel(r.term))
                },
                {
                    label: 'Total Interest',
                    current: currentLoan.totalInterest,
                    values: scenarioResults.map(r => r.totalInterest),
                    format: formatCurrency,
                    lowerIsBetter: true
                },
                {
                    label: 'Total Payments',
                    current: currentLoan.totalPayments,
                    values: scenarioResults.map(r => r.totalPayments),
                    format: formatCurrency,
                    lowerIsBetter: true
                },
                {
                    label: 'Refinancing Cost',
                    current: null,
                    values: scenarioResults.map(r => r.refinancingCost),
                    format: formatCurrency,
                    lowerIsBetter: true
                },
                {
                    label: 'Breakeven',
                    current: null,
                    values: scenarioResults.map(r => r.breakevenMonths),
                    format: v => {
                        if (v === 0) return 'Immediate';
                        if (!isFinite(v)) return 'Never';
                        return formatMonths(v);
                    },
                    lowerIsBetter: true
                },
                {
                    label: 'Lifetime Savings',
                    current: null,
                    values: scenarioResults.map(r => r.lifetimeSavings),
                    format: formatCurrency,
                    lowerIsBetter: false,
                    isHighlight: true
                }
            ];

            // Build body rows
            let bodyHTML = '';
            metrics.forEach(metric => {
                const rowClass = metric.isHighlight ? 'class="highlight-row"' : '';
                bodyHTML += `<tr ${rowClass}>`;
                bodyHTML += `<td>${metric.label}</td>`;

                // Find best value including current (excluding NaN and non-finite)
                const allValues = metric.current !== null ? [metric.current, ...metric.values] : metric.values;
                const validValues = allValues.filter(v => !isNaN(v) && isFinite(v));
                let bestValue = null;
                let worstValue = null;
                if (validValues.length > 1) {
                    bestValue = metric.lowerIsBetter
                        ? Math.min(...validValues)
                        : Math.max(...validValues);
                    worstValue = metric.lowerIsBetter
                        ? Math.max(...validValues)
                        : Math.min(...validValues);
                }

                // Current column
                if (metric.current !== null) {
                    let currentClass = 'current-col';
                    if (validValues.length > 1 && !isNaN(metric.current) && isFinite(metric.current)) {
                        if (metric.current === bestValue) {
                            currentClass += ' best-value';
                        } else if (metric.current === worstValue) {
                            currentClass += ' worst-value';
                        }
                    }
                    bodyHTML += `<td class="${currentClass}">${metric.format(metric.current)}</td>`;
                } else {
                    bodyHTML += `<td class="current-col">--</td>`;
                }

                // Scenario columns
                metric.values.forEach((value, i) => {
                    let cellClass = '';
                    if (!isNaN(value) && isFinite(value) && validValues.length > 1) {
                        if (value === bestValue) {
                            cellClass = 'best-value';
                        } else if (value === worstValue) {
                            cellClass = 'worst-value';
                        }
                    }

                    let cellContent = metric.format(value);
                    if (metric.detail && metric.detail[i]) {
                        cellContent += `<div class="value-detail">${metric.detail[i]}</div>`;
                    }

                    bodyHTML += `<td class="${cellClass}">${cellContent}</td>`;
                });

                bodyHTML += '</tr>';
            });

            comparisonBody.innerHTML = bodyHTML;
        }

        // Event delegation for scenarios
        scenariosContainer.addEventListener('input', (e) => {
            renderResults();
            updateURL();
        });

        scenariosContainer.addEventListener('change', (e) => {
            if (e.target.classList.contains('scenario-term')) {
                const section = e.target.closest('.scenario-section');
                const armFields = section.querySelector('.arm-fields');
                armFields.classList.toggle('visible', isARM(e.target.value));
            }
            renderResults();
            updateURL();
        });

        scenariosContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-scenario-btn')) {
                const section = e.target.closest('.scenario-section');
                const id = parseInt(section.dataset.scenarioId);
                removeScenario(id);
            }
            // Handle add scenario button click
            if (e.target.closest('.add-scenario-box')) {
                addScenario();
            }
        });

        // Keyboard support for add scenario button
        scenariosContainer.addEventListener('keydown', (e) => {
            if (e.target.closest('.add-scenario-box') && (e.key === 'Enter' || e.key === ' ')) {
                e.preventDefault();
                addScenario();
            }
        });

        scenariosContainer.addEventListener('blur', (e) => {
            if (e.target.classList.contains('scenario-closing-costs')) {
                formatInputCurrency(e.target);
            }
            if (e.target.classList.contains('scenario-name')) {
                syncScenariosFromDOM();
                renderResults();
                updateURL();
            }
        }, true);

        // Current loan inputs
        const currentLoanInputs = [currentBalanceInput, currentRateInput, currentPaymentInput];
        currentLoanInputs.forEach(input => {
            input.addEventListener('input', () => {
                renderResults();
                updateURL();
            });
        });

        [currentBalanceInput, currentPaymentInput].forEach(input => {
            input.addEventListener('blur', () => formatInputCurrency(input));
        });

        // URL parameter handling
        function buildURLParams() {
            const params = new URLSearchParams();

            // Current loan params
            const bal = currentBalanceInput.value.replace(/[$,]/g, '').trim();
            const rate = currentRateInput.value.trim();
            const pmt = currentPaymentInput.value.replace(/[$,]/g, '').trim();

            if (bal && bal !== '0') params.set('bal', bal);
            if (rate && rate !== '0') params.set('rate', rate);
            if (pmt && pmt !== '0') params.set('pmt', pmt);

            // Scenario params with index prefix
            syncScenariosFromDOM();
            state.scenarios.forEach((scenario, index) => {
                const prefix = `s${index + 1}_`;
                if (scenario.term) params.set(`${prefix}term`, scenario.term);
                if (scenario.rate) params.set(`${prefix}rate`, scenario.rate);
                if (scenario.armAdjustedRate) params.set(`${prefix}armRate`, scenario.armAdjustedRate);
                if (scenario.points && scenario.points !== '0') params.set(`${prefix}pts`, scenario.points);
                if (scenario.closingCosts && scenario.closingCosts !== '0') {
                    params.set(`${prefix}costs`, scenario.closingCosts.replace(/[$,]/g, ''));
                }
                if (scenario.name !== `Scenario ${index + 1}`) {
                    params.set(`${prefix}name`, scenario.name);
                }
            });

            return params;
        }

        function loadFromURL() {
            const params = new URLSearchParams(window.location.search);

            // Load current loan
            if (params.get('bal')) currentBalanceInput.value = params.get('bal');
            if (params.get('rate')) currentRateInput.value = params.get('rate');
            if (params.get('pmt')) currentPaymentInput.value = params.get('pmt');

            // Format money inputs
            [currentBalanceInput, currentPaymentInput].forEach(input => formatInputCurrency(input));

            // Detect scenario indices
            const scenarioIndices = new Set();
            for (const key of params.keys()) {
                const match = key.match(/^s(\d+)_/);
                if (match) scenarioIndices.add(parseInt(match[1]));
            }

            if (scenarioIndices.size > 0) {
                state.scenarios = [];
                const sortedIndices = [...scenarioIndices].sort((a, b) => a - b);

                sortedIndices.forEach(index => {
                    const prefix = `s${index}_`;
                    const scenario = createScenario();
                    scenario.term = params.get(`${prefix}term`) || '30';
                    scenario.rate = params.get(`${prefix}rate`) || '';
                    scenario.armAdjustedRate = params.get(`${prefix}armRate`) || '';
                    scenario.points = params.get(`${prefix}pts`) || '0';
                    scenario.closingCosts = params.get(`${prefix}costs`) || '0';
                    const customName = params.get(`${prefix}name`);
                    if (customName) scenario.name = customName;
                    state.scenarios.push(scenario);
                });
            } else {
                // No scenarios in URL, create default
                state.scenarios = [createScenario()];
            }

            renderScenarioInputs();
        }

        function updateURL() {
            const params = buildURLParams();
            const newURL = params.toString()
                ? `${window.location.pathname}?${params.toString()}`
                : window.location.pathname;
            window.history.replaceState({}, '', newURL);
        }

        // Initialize
        loadFromURL();
        renderResults();
    </script>
</body>
</html>
